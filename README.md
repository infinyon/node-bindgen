
![CI](https://github.com/infinyon/node-bindgen/workflows/CI/badge.svg)

<h1 align="center">node-bindgen</h1>
<div align="center">
 <strong>
   Fun way to write native Node.js module using sync and async rust
 </strong>
</div>

## Features

- __Fun:__ Just write regular Rust code, node-bindgen take care of generating Node.js FFI wrapper codes.
- __Safe:__ Take advantage of Rust type to check arguments. 
- __Async:__ Support Async Rust.  Async codes are translated into Node.js promises.
- __Class:__ Can write Node.js class.
- __Stream:__ Implement Node.js stream using Rust
- __N-API:__ Use Node.js N-API which means you don't have to recompile your module. 

# Compatibility with Node.js version

This project uses v5 of Node N-API.  Please see following [compatibility](https://nodejs.org/api/n-api.html#n_api_n_api_version_matrix) matrix.

Following OS are supported:
* Linux
* MacOs
* Windows



# Quick start


## Write idiomatic Rust Code 

Write a simple Rust code.  Noticed that:
* No need to deal with JS objects
* No FFI codes 
* No Node.js native module registration

They are generated by procedure macro.

```rust

use node_bindgen::derive::node_bindgen;

/// add two integer
#[node_bindgen]
fn sum(first: i32, second: i32) -> i32 {        
    first + second
}

```

## Generate Node module

Install nj-cli tool to generate Node.js dynamic library.
This is one time step.
```
cargo install nj-cli
```

Then build

```
nj-cli build
```

This will generate Node.js module in "./dist" folder.


## Using in Node.js

Then in the Node.js, function can be import simplest as below: 


```js
let addon = require('./dylib');

addon.sum(1,2)
3
```



# Features

##  Callback

Rust closures are mapped to JS callback

```rust
#[node_bindgen]
fn hello<F: Fn(String)>(first: f64, second: F) {

    let msg = format!("argument is: {}", first);

    second(msg);
}
```

from node:

```js
let addon = require('./dist');

addon.hello(2,function(msg){
  assert.equal(msg,"argument is: 2");
  console.log(msg);  // print out argument is 2
});
```


## Async functions

Async rust function is mapped to Node.js promise.

```rust

use std::time::Duration;
use flv_future_aio::time::sleep;
use node_bindgen::derive::node_bindgen;


#[node_bindgen]
async fn hello(arg: f64) -> f64 {
    println!("sleeping");
    sleep(Duration::from_secs(1)).await;
    println!("woke and adding 10.0");
    arg + 10.0
}
```

```js
let addon = require('./dist');

addon.hello(5).then((val) => {
  console.log("future value is %s",val);
});

```



## JavaScript class

JavaScript class is supported.

```rust

struct MyClass {
    val: f64,
}


#[node_bindgen]
impl MyClass {

    #[node_bindgen(constructor)]
    fn new(val: f64) -> Self {
        Self { val }
    }

    #[node_bindgen]
    fn plus_one(&self) -> f64 {
        self.val + 1.0
    }

    #[node_bindgen(getter)]
    fn value(&self) -> f64 {
        self.val
    }
}
```

```js
let addon = require('./dist');
const assert = require('assert');

let obj = new addon.MyObject(10);
assert.equal(obj.value,10,"verify value works");
assert.equal(obj.plusOne(),11);
```


